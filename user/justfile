target := "riscv64gc-unknown-none-elf"
mode := "release"
app_dir := "src/bin"
target_dir := "target" / target / mode

objcopy := "rust-objcopy --binary-architecture=riscv64"

build:
    #!/usr/bin/env python3
    import os
    import subprocess

    apps = os.listdir("{{app_dir}}")
    apps.sort()
    for app_id, app in enumerate(apps):
        base = os.path.splitext(app)[0]
        elf_target = os.path.join("{{target_dir}}", base)
        bin_target = elf_target + ".bin"

        print(f"Building {elf_target} from {{app_dir}}/{app}")
        subprocess.run(
            ["cargo", "build", "--target", "{{target}}", "--release", "--bin", base],
            check=True,
        )

        subprocess.run(
            [
                "rust-objcopy",
                "--binary-architecture=riscv64",
                elf_target,
                "--strip-all",
                "-O",
                "binary",
                bin_target,
            ],
            check=True,
        )
